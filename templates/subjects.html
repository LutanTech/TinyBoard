{% extends 'layout.html' %}
<title>{% block title %} Subjects {% endblock %}</title>
{% block content %}
<link rel="stylesheet" href="../static/css/main/dshb.css">
<link rel="stylesheet" href="../static/css/imports/tailwind.css">

<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="flex flex-wrap gap-5 justify-center mb-10">
        {% if subjects %}
            {% for subject in subjects %}
            <div id="subject-card-{{ subject.id }}" class="bg-gradient-to-r from-green-200 via-white to-cyan-100 border border-gray-300 rounded-xl shadow-md p-6 w-64 text-center transition-opacity duration-500">
                <h2 class="text-lg font-semibold text-gray-700">Subject ID: {{ subject.id }}</h2>
                <p class="text-md text-gray-600 mt-1">Name: <span class="font-medium">{{ subject.abr }}</span></p>
                <h2 class="text-md text-gray-600 mt-1">Grade: <span class="font-medium">{{ subject.grade }}</span></h2>
                <button type="button"
                        class="mt-4 w-full py-2 px-4 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-colors duration-300"
                        onclick="confirmDrop('{{ subject.id }}', '{{ teacher.id }}')"
                        aria-label="Drop subject {{ subject.abr }} with ID {{ subject.id }}">
                    Drop Subject
                </button>
            </div>
            {% endfor %}
        {% else %}
            <div class="bg-white border border-gray-300 rounded-xl shadow p-6">
                <p class="text-center font-semibold text-gray-600">You haven't added any subjects</p>
            </div>
        {% endif %}
    </div>

    <!-- Hidden Teacher ID for easy access -->
    <span id="trId" data-id="{{ teacher.id }}"></span>

    <form action="/add_subject" method="POST" class="bg-white border border-gray-200 rounded-xl shadow p-6 w-full max-w-md mx-auto space-y-4">
        <label for="name" class="block font-semibold text-gray-700">Enter Subject Name</label>
        <input type="text" name="name" class="w-full border-b border-gray-300 focus:border-blue-500 outline-none bg-transparent py-2 text-center" aria-label="Enter subject name" />

        <label for="abr" class="block font-semibold text-gray-700">Enter Subject Abbreviation</label>
        <input type="text" name="abr" class="w-full border-b border-gray-300 focus:border-blue-500 outline-none bg-transparent py-2 text-center" aria-label="Enter subject abbreviation" />

        <label for="grade" class="block font-semibold text-gray-700">Enter Grade</label>
        <input type="text" name="grade" class="w-full border-b border-gray-300 focus:border-blue-500 outline-none bg-transparent py-2 text-center" aria-label="Enter subject grade" />

        <button type="submit"
                class="w-full py-2 mt-4 bg-green-500 text-white rounded-full hover:bg-green-600 transition-colors duration-300"
                aria-label="Add new subject">
            Add Subject
        </button>
    </form>
</div>

<!-- Loading Spinner -->
<div id="loading-spinner " class="fixed inset-0 flex justify-center items-center bg-gray-900 bg-opacity-50 hidden z-50 none">
    <div class="w-16 h-16 border-4 border-t-4 border-blue-500 border-solid rounded-full animate-spin"></div>
</div>

<script>
function confirmDrop(subjectId, teacherId) {
    Swal.fire({
        title: "Are you sure?",
        text: "This will permanently delete the subject!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Yes, delete it!"
    }).then((result) => {
        if (result.isConfirmed) {
            // Show the loading spinner
            // document.getElementById("loading-spinner").classList.remove("hidden");

            fetch(`/drop_subject/${subjectId}/${teacherId}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                // Hide the loading spinner
                // document.getElementById("loading-spinner").classList.add("hidden");

                if (data.status === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: 'Deleted!',
                        text: data.message,
                        timer: 1500,
                        showConfirmButton: false
                    });

                    const card = document.getElementById('subject-card-' + subjectId);
                    card.style.opacity = '0';
                    setTimeout(() => card.remove(), 500);
                } else {
                    Swal.fire('Error!', data.message, 'error');
                }
            })
            .catch(() => {
                // Hide the loading spinner
                // document.getElementById("loading-spinner").classList.add("hidden");
                Swal.fire('Error!', 'Something went wrong.', 'error');
            });
        }
    });
}
</script>

<div class="flash-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <script>
                Swal.fire({
                    icon: "{{ category }}",
                    html: "{{ message }}",
                    toast: true,
                    position: "top-end",
                    showConfirmButton: false,
                    timer: 3000
                });
            </script>
            {% endfor %}
        {% endif %}
    {% endwith %}
</div>
{% endblock %}
